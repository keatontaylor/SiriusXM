<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Liquid Glass Modern HLS Player</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  :root {
    --bg-gradient: linear-gradient(135deg,#0b0b0b,#111);
    --glass-bg: rgba(30,30,30,0.55);
    --glass-blur: 25px;
    --accent: #0ff;
    --accent-hover: #0cc;
    --text-primary: #fff;
    --text-secondary: #ccc;
    --radius: 20px;
    --shadow: rgba(0,0,0,0.5);
  }

  * { box-sizing:border-box; margin:0; padding:0; }
  body {
    font-family: 'SF Pro', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    background: var(--bg-gradient);
    color: var(--text-primary);
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 100vh;
    padding: 0;
  }

  /* --- Top Bar --- */
  #topBar {
    width: 100%;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 20px;
    backdrop-filter: blur(var(--glass-blur));
    -webkit-backdrop-filter: blur(var(--glass-blur));
    background: var(--glass-bg);
    border-bottom: 1px solid rgba(255,255,255,0.08);
    position: sticky;
    top: 0;
    z-index: 999;
  }

  .top-btn {
    background: var(--glass-bg);
    border: none;
    border-radius: var(--radius);
    padding: 10px 14px;
    cursor: pointer;
    font-size: 1.1rem;
    color: var(--text-primary);
    box-shadow: 0 6px 18px var(--shadow);
    transition: all 0.2s ease;
  }
  .top-btn:hover { 
    background: rgba(40,40,40,0.6);
    transform: translateY(-2px);
    box-shadow: 0 10px 24px var(--shadow);
  }

  /* --- Settings Panel --- */
  #settingsPanel {
    position: fixed;
    top: 60px;
    left: 10px;
    width: 220px;
    background: var(--glass-bg);
    backdrop-filter: blur(var(--glass-blur));
    border-radius: var(--radius);
    padding: 16px;
    box-shadow: 0 12px 36px var(--shadow);
    border: 1px solid rgba(255,255,255,0.08);
    display: none;
    z-index: 998;
  }
  #settingsPanel h3 { color: var(--accent); margin-bottom: 12px; font-size: 1.1rem; }

  /* --- Channel Drawer --- */
  #channelDrawer {
    position: fixed;
    top: 0;
    right: 0;
    transform: translateX(100%);
    width: 100%;
    max-width: 420px;
    height: 100vh;
    background: var(--glass-bg);
    backdrop-filter: blur(var(--glass-blur));
    -webkit-backdrop-filter: blur(var(--glass-blur));
    box-shadow: -6px 0 24px var(--shadow);
    padding: 25px;
    overflow-y: auto;
    transition: transform 0.35s ease;
    z-index: 997;
    border-top-left-radius: var(--radius);
    border-bottom-left-radius: var(--radius);
    border: 1px solid rgba(255,255,255,0.08);
  }
  #channelDrawer.open { transform: translateX(0); }
  #closeDrawer {
    background: transparent;
    color: var(--text-secondary);
    font-size: 0.9rem;
    cursor: pointer;
    float: right;
    margin-bottom: 10px;
  }

  #channelDrawer h2 {
    margin-bottom: 20px;
    font-weight: 700;
    font-size: 1.4rem;
    color: var(--accent);
    text-align: center;
  }

  /* --- Channel Grid --- */
  #channelGrid {
    display: flex;
    overflow-x: auto;
    gap: 16px;
    padding-bottom: 10px;
  }
  #channelGrid::-webkit-scrollbar { height: 8px; }
  #channelGrid::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 4px; }

  .channel-card {
    flex: 0 0 auto;
    width: 110px;
    background: var(--glass-bg);
    backdrop-filter: blur(var(--glass-blur));
    border-radius: var(--radius);
    padding: 12px;
    text-align: center;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    transition: transform 0.25s ease, box-shadow 0.25s ease;
    border: 1px solid rgba(255,255,255,0.05);
  }
  .channel-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 16px 40px var(--shadow);
    border-color: rgba(255,255,255,0.15);
  }
  .channel-card img {
    width: 90px;
    height: 90px;
    border-radius: var(--radius);
    object-fit: cover;
    opacity: 0;
    transition: opacity 0.4s ease, transform 0.3s ease;
  }
  .channel-card:hover img { transform: scale(1.05); }
  .channel-name { font-size: 0.85rem; font-weight: 500; color: var(--text-primary); text-align: center; }

  .cng-btn {
    padding: 6px 12px;
    font-size: 0.75rem;
    border-radius: var(--radius);
    background: var(--accent);
    color: #000;
    font-weight: 600;
    border: none;
    cursor: pointer;
    transition: background 0.2s;
  }
  .cng-btn:hover { background: var(--accent-hover); }

  /* --- Now Playing --- */
  #now-playing {
    margin-top: 30px;
    text-align: center;
    max-width: 450px;
    width: 100%;
    background: var(--glass-bg);
    backdrop-filter: blur(var(--glass-blur));
    border-radius: var(--radius);
    padding: 25px;
    box-shadow: 0 16px 48px var(--shadow);
    border: 1px solid rgba(255,255,255,0.05);
  }

  #artwork {
    width: 320px;
    height: 320px;
    border-radius: var(--radius);
    object-fit: cover;
    box-shadow: 0 12px 36px var(--shadow);
    margin-bottom: 16px;
    transition: transform 0.3s ease;
  }
  #artwork:hover { transform: scale(1.02); }

  #channelInfo { font-size: 1.7rem; font-weight: 700; margin-bottom: 10px; }
  #songInfo { font-size: 1.1rem; color: var(--text-secondary); line-height: 1.4; }
  #player { width: 100%; margin-top: 16px; border-radius: var(--radius); outline: none; }
  .hidden { display:none !important; }
</style>
</head>
<body>

<!-- Top Bar -->
<div id="topBar">
  <button id="settingsBtn" class="top-btn">‚öôÔ∏è</button>
  <button id="openChannelsBtn" class="top-btn">üì° Browse Channels</button>
</div>

<!-- Settings Panel -->
<div id="settingsPanel">
  <h3>Settings</h3>
  <button id="serverModeToggle" class="top-btn" style="width:100%; margin-bottom:10px;">üõë Server Mode: OFF</button>
  <button id="honorServerToggle" class="top-btn" style="width:100%;">üéõ Honor Server Channel: ON</button>
</div>

<!-- Channel Drawer -->
<div id="channelDrawer">
  <div id="closeDrawer">‚úï Close</div>
  <h2>Channel List</h2>
  <div id="channelGrid"></div>
</div>

<!-- Now Playing -->
<div id="now-playing">
  <img id="artwork" src="play.png">
  <div id="channelInfo">Loading‚Ä¶</div>
  <div id="songInfo"></div>
  <audio id="player" controls playsinline></audio>
</div>

<script>
const DEFAULT_ARTWORK="play.png";
const player=document.getElementById("player");
const artwork=document.getElementById("artwork");
const channelInfo=document.getElementById("channelInfo");
const songInfo=document.getElementById("songInfo");
const drawer=document.getElementById("channelDrawer");
const settingsPanel=document.getElementById("settingsPanel");

let channels=[];
let currentChannelArtwork=DEFAULT_ARTWORK;
let currentChannelId=null;

let serverMode = false;
let honorServer = true; // default ON
const honorBtn = document.getElementById("honorServerToggle");

// Toggle Settings Panel
document.getElementById("settingsBtn").onclick = () => {
  settingsPanel.style.display = settingsPanel.style.display==='block'?'none':'block';
};

// Drawer
document.getElementById("openChannelsBtn").onclick = () => {
  if(!serverMode && honorServer){
    alert("Cannot browse channels while honor server channels is ON");
    return;
  }
  drawer.classList.add("open");
};
document.getElementById("closeDrawer").onclick = () => drawer.classList.remove("open");

// Server Mode toggle
document.getElementById("serverModeToggle").onclick = () => {
  serverMode = !serverMode;
  document.getElementById("serverModeToggle").textContent = `üõë Server Mode: ${serverMode?"ON":"OFF"}`;
  if(serverMode){
    honorServer = true;
    honorBtn.classList.add("hidden");
    player.pause();
    player.classList.add("hidden");
    document.querySelectorAll(".cng-btn").forEach(b=>b.classList.remove("hidden"));
  } else {
    honorBtn.classList.remove("hidden");
    document.querySelectorAll(".cng-btn").forEach(b=>b.classList.add("hidden"));
    player.classList.remove("hidden");
    if(currentChannelId && !honorServer){
      loadChannel(channels.find(c=>c.channelId===currentChannelId));
    }
  }
};

// Honor Server toggle (only when serverMode OFF)
honorBtn.onclick = () => {
  if(serverMode) return; 
  honorServer = !honorServer;
  honorBtn.textContent = `üéõ Honor Server Channel: ${honorServer?"ON":"OFF"}`;
};

// Send .cng
async function sendChannelChange(id){
  if(!id) return;
  try{ await fetch(`/${id}.cng`); console.log("Sent channel change ‚Üí", id); }
  catch(e){console.error(e);}
}

// Update current song
async function updateCurrentSong(){
  if(!currentChannelId) return;
  try{
    const res = await fetch(`/${currentChannelId}.json`);
    const t = await res.json();
    const ttl = t.title||"";
    const art = t.artists?.[0]?.name||"";
    const alb = t.album?.title||"";
    const artURL = t.album?.creativeArts?.find(a=>a.size==="MEDIUM")?.url || currentChannelArtwork;

    const chName = channels.find(c=>c.channelId===currentChannelId)?.name || "";
    channelInfo.textContent = `${chName}`;
    songInfo.innerHTML = `${ttl}<br>${art}`;

    artwork.src = artURL;
    if('mediaSession' in navigator)
      navigator.mediaSession.metadata = new MediaMetadata({title:ttl, artist:art, album:alb, artwork:[{src:artURL}]});
  }catch(e){console.error(e);}
}

// Load channels
async function loadChannels(){
  try{
    const res = await fetch("/channels.m3u");
    const lines = (await res.text()).split(/\r?\n/);
    channels = [];
    for(let i=0;i<lines.length;i++){
      if(lines[i].startsWith("#EXTINF:")){
        const displayName = lines[i].split(",")[1]?.trim()||"Unknown";
        const channelIdMatch = lines[i].match(/tvg-id="([^"]+)"/);
        const channelId = channelIdMatch ? channelIdMatch[1] : displayName.replace(/\s+/g,"_").toLowerCase();
        const url = lines[i+1]?.trim();
        if(!url) continue;
        const logoMatch = lines[i].match(/tvg-logo="([^"]+)"/);
        let logo=currentChannelArtwork;
        if(logoMatch){
          const original = logoMatch[1];
          logo=(location.protocol==="https:" && original.startsWith("http://")) ? `/proxy/${encodeURIComponent(original)}` : original;
        }
        channels.push({name:displayName,url,logo,channelId});
      }
    }

    const grid=document.getElementById("channelGrid");
    grid.innerHTML="";
    channels.forEach(ch=>{
      const card = document.createElement("div");
      card.className="channel-card";
      card.innerHTML = `<img data-logo="${ch.logo}" alt="logo"><div class="channel-name">${ch.name}</div><button class="cng-btn ${serverMode?'':'hidden'}">Send to Web Players</button>`;

      card.addEventListener("click", ()=>{ 
        if(serverMode){
          sendChannelChange(ch.channelId);
          currentChannelId = ch.channelId;
          currentChannelArtwork = ch.logo;
          artwork.src = ch.logo;
          channelInfo.textContent = `${ch.name}`;
          songInfo.textContent = "";
        } else {
          loadChannel(ch);
        }
        drawer.classList.remove("open"); 
      });

      card.querySelector(".cng-btn").addEventListener("click", e=>{
        e.stopPropagation();
        sendChannelChange(ch.channelId);
        if(serverMode){
          currentChannelId = ch.channelId;
          currentChannelArtwork = ch.logo;
          artwork.src = ch.logo;
          channelInfo.textContent = `${ch.channelId} - ${ch.name}`;
          songInfo.textContent = "";
        }
      });

      grid.appendChild(card);
    });

    setupLazyLoading();
    if(channels.length && !serverMode) loadChannel(channels[0]);

  }catch(e){console.error(e);}
}

// Lazy load images
function setupLazyLoading(){
  const imgs=document.querySelectorAll('#channelGrid img[data-logo]');
  const observer=new IntersectionObserver(entries=>{
    entries.forEach(entry=>{
      if(entry.isIntersecting){
        const img=entry.target;
        img.src=img.dataset.logo;
        img.onload=()=>img.style.opacity=1;
        img.removeAttribute("data-logo");
        observer.unobserve(img);
      }
    });
  },{root:drawer,rootMargin:"120px"});
  imgs.forEach(img=>observer.observe(img));
}

// Load channel
function loadChannel(ch){
  currentChannelArtwork = ch.logo;
  currentChannelId = ch.channelId;
  channelInfo.textContent = `${ch.name}`;
  songInfo.textContent = "";
  if(!serverMode){
    player.src = ch.url;
    player.play().catch(()=>{});
  }
  artwork.src = ch.logo;
}

// Poll /current.chn
async function pollForcedChannel(){
  if(!honorServer) return;
  try{
    const r=await fetch("/current.chn");
    const forced=(await r.text()).trim();
    if(forced && forced!==currentChannelId){
      const f=channels.find(c=>c.channelId===forced);
      if(f){
        loadChannel(f);      
        updateCurrentSong();  
      }
    }
  }catch(e){}
}

loadChannels();
setInterval(updateCurrentSong,3000);
setInterval(pollForcedChannel,5000);
updateCurrentSong();
pollForcedChannel();
</script>
</body>
</html>
