<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>HLS Audio Player with Channels</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    background: #111;
    color: #fff;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 30px;
  }

  #now-playing {
    text-align: center;
    margin-bottom: 20px;
    max-width: 350px;
  }

  #artwork {
    width: 250px;
    height: 250px;
    border-radius: 12px;
    object-fit: cover;
    box-shadow: 0 0 15px rgba(0,0,0,0.6);
    margin-bottom: 15px;
  }

  #title {
    font-size: 1.4rem;
    font-weight: 600;
    margin-bottom: 10px;
  }

  select {
    margin-bottom: 20px;
    padding: 8px 12px;
    font-size: 1rem;
    border-radius: 6px;
    border: none;
    outline: none;
  }

  /* Small video for native controls only */
  #player {
    width: 300px;      /* enough for native controls */
    height: 40px;
    object-fit: contain;
    background: transparent;
  }
</style>
</head>
<body>

<h2>Channel Selector</h2>
<select id="channelSelect"></select>

<div id="now-playing">
  <img id="artwork" src="play.png" alt="Album Art">
  <div id="title">Loading…</div>
  <audio id="player" controls playsinline></audio>
</div>

<script>
const player = document.getElementById("player");
const select = document.getElementById("channelSelect");
const artwork = document.getElementById("artwork");
const title = document.getElementById("title");

let channels = [];
const DEFAULT_ARTWORK = "play.png";

// Update Media Session metadata and UI
function updateMetadata(track) {
  title.textContent = track.title || "";
  artwork.src = track.artwork || DEFAULT_ARTWORK;

  if ('mediaSession' in navigator) {
    navigator.mediaSession.metadata = new MediaMetadata({
      title: track.title || "",
      artist: track.artist || "",
      album: track.album || "",
      artwork: [
        { src: track.artwork || DEFAULT_ARTWORK, sizes: "96x96", type: "image/jpeg" },
        { src: track.artwork || DEFAULT_ARTWORK, sizes: "192x192", type: "image/jpeg" },
        { src: track.artwork || DEFAULT_ARTWORK, sizes: "512x512", type: "image/jpeg" }
      ]
    });
  }
}

// Load M3U from backend and populate channel selector

async function updateCurrentSong() {
  try {
    const res = await fetch("/current_song.json"); // endpoint returning JSON
    const track = await res.json();

    const titleText = track.title || "";
    const artistText = track.artists?.[0]?.name || "";
    const albumTitle = track.album?.title || "";

    // Pick MEDIUM artwork if available
    const artworkUrl = track.album?.creativeArts?.find(a => a.size === "MEDIUM")?.url || DEFAULT_ARTWORK;

    // Update on-page UI
    title.innerHTML = `${titleText}<br>${artistText}`;
    artwork.src = artworkUrl;

    // Update Media Session
    if ('mediaSession' in navigator) {
      navigator.mediaSession.metadata = new MediaMetadata({
        title: titleText,
        artist: artistText,
        album: albumTitle,
        artwork: [
          { src: artworkUrl, sizes: "96x96", type: "image/jpeg" },
          { src: artworkUrl, sizes: "192x192", type: "image/jpeg" },
          { src: artworkUrl, sizes: "512x512", type: "image/jpeg" }
        ]
      });
    }

  } catch (err) {
    console.error("Failed to update current song:", err);
  }
}

async function loadChannels() {
  try {
    const res = await fetch("/channels.m3u"); // backend endpoint serving M3U
    const text = await res.text();
    const lines = text.split(/\r?\n/);

    channels = [];
    for (let i = 0; i < lines.length; i++) {
      if (lines[i].startsWith("#EXTINF:")) {
        const name = lines[i].split(",")[1].trim();
        const url = lines[i+1]?.trim();
        if (url) channels.push({ name, url });
      }
    }

    // Populate <select>
    channels.forEach(ch => {
      const opt = document.createElement("option");
      opt.value = ch.url;
      opt.textContent = ch.name;
      select.appendChild(opt);
    });

    // Auto-load first channel
    if (channels.length) loadChannel(channels[0].url, channels[0].name);

  } catch (err) {
    console.error("Failed to load channels:", err);
  }
}

// Handle channel change
select.addEventListener("change", () => {
  const selected = channels.find(ch => ch.url === select.value);
  if (selected) loadChannel(selected.url, selected.name);
});

// Load channel into video player
function loadChannel(url, name) {
  player.src = url;
  player.play().catch(() => {
    // Autoplay blocked — wait for user gesture
    const start = () => { player.play(); removeListeners(); };
    const removeListeners = () => {
      document.removeEventListener("click", start);
      document.removeEventListener("touchstart", start);
    };
    document.addEventListener("click", start);
    document.addEventListener("touchstart", start);
  });

  // Update UI + Media Session
  updateMetadata({
    title: name,
    artist: "",
    album: "",
    artwork: DEFAULT_ARTWORK
  });
}

// Initialize on DOM ready
document.addEventListener("DOMContentLoaded", loadChannels);
setInterval(updateCurrentSong, 1000);
updateCurrentSong(); // initial call
</script>

</body>
</html>
